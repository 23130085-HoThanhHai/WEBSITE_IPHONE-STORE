{% load static humanize custom_filters %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apple-shops-cart</title>

    <!-- google font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- style -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />

    <!-- icon -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
    />
  </head>

  <body>
    <!-- Navbar -->
    {% include 'navbar.html' %}

    <!-- Cart Section -->
    <section class="product" id="cart">
      <h1 class="heading-title">Your Shopping Cart</h1>

      <div class="cart-wrapper">
        {% for item in cart.items.all %}
        <div class="cart-item" data-item-id="{{ item.id }}">
            <div class ="product_main">
                <div class="product-image">
                <img src="{{ item.variant.image.url }}" alt="{{ item.product.name }}" />
                </div>
                <div class="product-detail">
                    <h4>{{ item.product.name }} ({{ item.variant.storage }}/{{ item.variant.color }})</h4>
                        <span class="price" data-unit-price="{{ item.variant.final_price }}">
                            {{ item.variant.final_price|floatformat:0|intcomma }} VNƒê
                        </span>
            
                <div class="quantity-control">
              <button class="qty-btn update-qty" data-action="minus">-</button>
              <input type="text" value="{{ item.quantity }}" class="qty-input" readonly />
              <button class="qty-btn update-qty" data-action="plus">+</button>
              
            </div>
            
            <p class="subtotal">
                T·∫°m t√≠nh: <strong class="item-total">{{ item.get_cost|floatformat:0|intcomma }} VNƒê</strong>
            </p>
            <a href="#" class="remove-item delete-cart-item" data-item-id="{{ item.id }}" style="color: #ff3b30; font-size: 0.8rem;">X√≥a s·∫£n ph·∫©m</a>
          </div>
            </div>
          
        </div>
        {% empty %}
        <div class="empty-cart-message">
            <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
            <a href="{% url 'index' %}" style="color: #0071e3;">Ti·∫øp t·ª•c mua s·∫Øm</a>
        </div>
        {% endfor %}
      </div>

      {% if cart.items.all %}
      <div class="upsell-container" style="padding: 20px; background: #fff; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e5e5e5;">
          <p id="upsell-text" style="font-weight: 500; margin-bottom: 10px; color: #1d1d1f;"></p>
          <div style="width: 100%; height: 8px; background: #f5f5f7; border-radius: 4px; overflow: hidden;">
              <div id="upsell-bar" style="width: 0%; height: 100%; background: #34c759; transition: width 0.3s ease;"></div>
          </div>
      </div>
      <div class="cart-summary">
        <h3>T·ªïng c·ªông</h3>
        <p>T·∫°m t√≠nh: <strong id="cart-total">{{ cart.get_total_price|floatformat:0|intcomma }} VNƒê</strong></p>
        <div style="display:flex; gap:8px; justify-content:flex-end; align-items:center;">
          <button id="clear-cart-btn" class="checkout-btn" style="background:#fff; color:#d9534f; border:1px solid #f0dede;">X√≥a t·∫•t c·∫£</button>
          <a href="{% url 'checkout' %}" class="swiper-btn checkout-btn checkout-link">Thanh to√°n</a>
        </div>
      </div>
      {% endif %}
    </section>

    <!--footer-->
    {% include 'footer.html' %}

    <!-- Chatbox AI-->
    {% include 'chatbox.html' %}

    <script>
      $(document).ready(function() {

        // H√†m chuy·ªÉn ƒë·ªïi chu·ªói "1.000.000 VNƒê" th√†nh s·ªë 1000000
        function parsePrice(priceString) {
            if (typeof priceString !== 'string') return priceString;
            return parseInt(priceString.replace(/[^\d]/g, '')) || 0;
        }

        // CH·∫†Y L·∫¶N ƒê·∫¶U KHI TRANG LOAD
        let initialTotal = parsePrice($('#cart-total').text());
        updateUpsell(initialTotal);
          // 1. X·ª¨ L√ù TƒÇNG GI·∫¢M S·ªê L∆Ø·ª¢NG
          $('.update-qty').off('click').on('click', function(e) {
              e.preventDefault();
              let btn = $(this);
              let itemContainer = btn.closest('.cart-item');
              let itemId = itemContainer.data('item-id');
              let action = btn.data('action');

              $.ajax({
                  url: "{% url 'update_cart_item' %}",
                  method: "POST",
                  data: {
                      'item_id': itemId,
                      'action': action,
                      'csrfmiddlewaretoken': '{{ csrf_token }}'
                  },
                  success: function(response) {
                      // C·∫≠p nh·∫≠t gi√° tr·ªã ngay l·∫≠p t·ª©c tr√™n m√†n h√¨nh
                      itemContainer.find('.qty-input').val(response.new_quantity);
                      itemContainer.find('.item-total').text(response.item_total);
                      $('#cart-total').text(response.cart_total);
                      // C·∫¨P NH·∫¨T THANH TI·∫æN TR√åNH
                      updateUpsell(parsePrice(response.cart_total));
                  },
                  error: function(xhr, status, error) {
                      console.log(xhr.status + ": " + xhr.responseText);
                      alert('C√≥ l·ªói x·∫£y ra t·∫°i Server. Nh·∫•n F12 v√† xem tab Console nh√©!');
                  }
              });
          });

          // 2. X·ª¨ L√ù X√ìA S·∫¢N PH·∫®M B·∫∞NG AJAX
          $('.delete-cart-item').on('click', function(e) {
              e.preventDefault();
              if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;

              let btn = $(this);
              let itemContainer = btn.closest('.cart-item');
              let itemId = btn.data('item-id');

              $.ajax({
                  url: "/cart/remove/" + itemId + "/", // Ph·∫£i kh·ªõp v·ªõi URL name='remove_cart_item'
                  method: "POST",
                  data: {
                      'csrfmiddlewaretoken': '{{ csrf_token }}'
                  },
                  success: function(response) {
                      // Hi·ªáu ·ª©ng bi·∫øn m·∫•t d·∫ßn r·ªìi x√≥a kh·ªèi giao di·ªán
                      itemContainer.fadeOut(300, function() {
                          $(this).remove();
                          // C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn gi·ªè h√†ng t·ª´ response (n·∫øu view c√≥ tr·∫£ v·ªÅ)
                          if(response.cart_total) {
                              $('#cart-total').text(response.cart_total);
                              // C·∫¨P NH·∫¨T THANH TI·∫æN TR√åNH
                              updateUpsell(parsePrice(response.cart_total));
                          } else {
                              location.reload(); // N·∫øu ch∆∞a vi·∫øt view tr·∫£ v·ªÅ total th√¨ reload t·∫°m
                          }
                          
                          // N·∫øu kh√¥ng c√≤n s·∫£n ph·∫©m n√†o th√¨ hi·ªán th√¥ng b√°o tr·ªëng
                          if ($('.cart-item').length === 0) {
                              $('.cart-wrapper').html('<div class="empty-cart-message" style="text-align: center; padding: 50px;"><p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p><a href="/" style="color: #0071e3;">Ti·∫øp t·ª•c mua s·∫Øm</a></div>');
                              $('.cart-summary').remove();
                          }
                      });
                  }
              });
          });

                // 3. X·ª¨ L√ù TH√äM / B·ªé PH·ª§ KI·ªÜN KHI CHECKBOX THAY ƒê·ªîI (binding at document ready)
                $('.toggle-accessory').off('change').on('change', function(e) {
                  let chk = $(this);
                  let variantId = chk.data('variant-id');
                  let checked = chk.is(':checked');

                  $.ajax({
                    url: "{% url 'toggle_accessory' %}",
                    method: "POST",
                    data: {
                      'variant_id': variantId,
                      'checked': checked,
                      'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                      if (response.cart_total) {
                        $('#cart-total').text(response.cart_total);
                        // C·∫¨P NH·∫¨T THANH TI·∫æN TR√åNH
                        updateUpsell(parsePrice(response.cart_total));
                      }
                    },
                    error: function(xhr) {
                      console.error('Accessory toggle error', xhr);
                      alert('C√≥ l·ªói khi x·ª≠ l√Ω ph·ª• ki·ªán. Vui l√≤ng th·ª≠ l·∫°i.');
                      // revert checkbox state on error
                      chk.prop('checked', !checked);
                    }
                  });
                });

                // Clear cart button (bind on document ready)
                $('#clear-cart-btn').off('click').on('click', function(e) {
                  e.preventDefault();
                  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô s·∫£n ph·∫©m trong gi·ªè h√†ng?')) return;
                  $.ajax({
                    url: "{% url 'clear_cart' %}",
                    method: "POST",
                    data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
                    success: function(response) {
                      if (response.status === 'success') {
                        // simple reload to reflect empty cart
                        location.reload();
                      }
                    },
                    error: function(xhr) {
                      alert('C√≥ l·ªói x·∫£y ra khi x√≥a gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
                    }
                  });
                });
      });

      // GI·ªÆ NGUY√äN H√ÄM N√ÄY PH√çA D∆Ø·ªöI
    function updateUpsell(currentTotal) {
        const TIERS = [
            { threshold: 5000000, discount: 50000 },
            { threshold: 10000000, discount: 100000 },
            { threshold: 20000000, discount: 200000 },
            { threshold: 30000000, discount: 500000 }
        ];

        let text = "";
        let progress = 0;
        let nextTier = TIERS.find(t => currentTotal < t.threshold);

        if (nextTier) {
            let needed = nextTier.threshold - currentTotal;
            text = `Mua th√™m <b>${needed.toLocaleString('vi-VN')} VNƒê</b> ƒë·ªÉ ƒë∆∞·ª£c gi·∫£m ngay <b>${nextTier.discount.toLocaleString('vi-VN')} VNƒê</b>`;
            
            let prevThreshold = 0;
            let index = TIERS.indexOf(nextTier);
            if (index > 0) prevThreshold = TIERS[index-1].threshold;
            
            progress = ((currentTotal - prevThreshold) / (nextTier.threshold - prevThreshold)) * 100;
        } else {
            text = "üéâ Tuy·ªát v·ªùi! B·∫°n ƒë√£ ƒë·∫°t m·ª©c gi·∫£m gi√° cao nh·∫•t (500.000 VNƒê)";
            progress = 100;
        }

        $('#upsell-text').html(text);
        $('#upsell-bar').css('width', progress + '%');
    }
</script>

<script src="{% static 'js/app.js' %}"></script>
</script>
  </body>
</html>
