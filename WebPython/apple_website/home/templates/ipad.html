{% load static humanize custom_filters %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apple Shops - Ipad</title>

    <!-- Google font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Style -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
    />

    <!-- Isotope filter -->
    <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.js"></script>

    <style>
      .product-container {
        margin-top: 100px;
        padding: 2rem;
      }

      .page-title {
        font-size: 36px;
        font-weight: 800;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .search-box {
        width: 100%;
        text-align: center;
        margin-bottom: 2rem;
      }

      .search-box input {
        width: 50%;
        padding: 0.8rem 1rem;
        border-radius: 20px;
        border: 1px solid #ccc;
        font-size: 1rem;
        outline: none;
      }

      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 2rem;
        transition: all 0.3s ease;
      }

      .product-card {
        position: relative;
        background: var(--whiteColor);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: rgba(0, 0, 0, 0.15) 0 4px 12px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: rgba(0, 0, 0, 0.25) 0 6px 15px;
      }

      .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      .product-detail {
        padding: 1rem;
        text-align: center;
      }

      .product-button {
        width: 80%;
        padding: 0.8rem;
        border: none;
        border-radius: 8px;
        background: var(--primaryColor);
        color: white;
        cursor: pointer;
        transition: background 0.3s;
      }

      .product-button:hover {
        background: var(--fontColor);
      }

      /* HOVER INFO BOX */
      .hover-info {
        position: absolute;
        top: 0;
        left: 0;
        background: rgba(255, 255, 255, 0.95);
        width: 100%;
        height: 100%;
        padding: 1rem;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        line-height: 1.4rem;
      }

      .product-card:hover .hover-info {
        opacity: 1;
        visibility: visible;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    {% include 'navbar.html' %}

    <main class="product-container">
      <h2 class="page-title">Ipad</h2>
      <hr />

      <!-- √î t√¨m ki·∫øm -->
      <div class="search-box">
        <input
          type="text"
          id="searchInput"
          placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..."
        />
      </div>

      <!-- B·ªô l·ªçc s·∫£n ph·∫©m -->
      <div class="filter-bar">
        <select id="filterSeries">
          <option value="*">T·∫•t c·∫£ d√≤ng</option>
          <option value="Air">iPad Air</option>
          <option value="Pro">iPad Pro</option>
          <option value="Mini">iPad Mini</option>
          <option value="Gen">iPad Gen</option>
        </select>

        <select id="filterStatus">
          <option value="*">T·∫•t c·∫£</option>
          <option value="new">New</option>
          <option value="bestseller">Best Seller</option>
          <option value="promo">Promo</option>
        </select>

        <select id="filterStorage">
          <option value="*">Dung l∆∞·ª£ng</option>
          <option value="64">64GB</option>
          <option value="128">128GB</option>
          <option value="256">256GB</option>
          <option value="512">512GB</option>
        </select>

        <select id="filterPrice">
          <option value="*">Gi√°</option>
          <option value="2">10 ‚Äì 20 tri·ªáu</option>
          <option value="3">Tr√™n 20 tri·ªáu</option>
        </select>
      </div>

      <div class="product-grid" id="productGrid">
        <!-- PRODUCT CARD -->
        {% if search_query %}
            <div class="search-status" style="margin-bottom: 20px; padding: 0 20px;">
              <p style="color: #86868b;">ƒêang hi·ªÉn th·ªã k·∫øt qu·∫£ cho: <strong style="color: #1d1d1f;">"{{ search_query }}"</strong></p>
            </div>
        {% endif %}
        {% for product in products %}
          {% with product.variants.first as variant %}
            {% if variant %}
        <div
          class="product-card accessory"
          data-price="{{ variant.final_price|floatformat:0|cut:"," }}"
          data-status="{% if product.is_new %}new{% elif product.is_bestseller %}bestseller{% else %}promo{% endif %}"
          data-promo="{% if variant.price > variant.final_price %}promo{% endif %}"
          data-series="{{ product.name|extract_ipad_variant }}"
          data-storage="{{ variant.storage|default:'' }}"
        >
          {% if product.is_new %}
          <div class="product-label label-red">New</div>
          {% elif product.is_bestseller %}
          <div class="product-label label-blue">Best Seller</div>
          {% elif variant.price > variant.final_price %}
          <div class="product-label label-yellow">
              {% if variant.discount_percent > 0 %}
                  Sale {{ variant.discount_percent }}%
              {% else %}
                  Hot Deal
              {% endif %}
          </div>
          {% endif %}

          <img
            class="product-image"
            src="{{ variant.image.url|default:'#' }}"
            alt="{{ product.name|default:'S·∫£n ph·∫©m' }}"
          />

          <div class="product-detail">
            <h4>
              {{ product.name|default:'[T√™n s·∫£n ph·∫©m]' }}<i
                class="far fa-heart"
              ></i>
            </h4>
            <div class="rating">...</div>
            <div class="price-display">
                {% if variant.price > variant.final_price %}
                    <span style="text-decoration: line-through; color: #8e8e93; font-size: 0.85em;">
                        {{ variant.price|floatformat:0|intcomma }} VNƒê
                    </span><br>
                    <span style="color: #d70018; font-weight: 600;">
                        {{ variant.final_price|floatformat:0|intcomma }} VNƒê
                    </span>
                {% else %}
                    <span>{{ variant.price|floatformat:0|intcomma }} VNƒê</span>
                {% endif %}
            </div>
          </div>

          <div class="hover-info">
            <p>
              <strong>T√¨nh tr·∫°ng:</strong> C√≤n {{ variant.stock_quantity|default:0 }} s·∫£n ph·∫©m
            </p>
            <p>
              <strong>Gi·∫£m gi√°:</strong> {{ variant.discount_percent|default:0 }}%
            </p>
            <p>
              <strong>B·∫£o h√†nh:</strong> {{ product.warranty_months|default:12 }} th√°ng
            </p>
            <p>
              <strong>Dung l∆∞·ª£ng:</strong> {{ variant.storage|default:'N/A' }}
            </p>
            <p>
              <strong>V·∫≠n chuy·ªÉn:</strong> {{ product.shipping_info|default:'Mi·ªÖn ph√≠' }}
            </p>
            <p>
              <strong><a href="{% url 'product_detail' product_slug=product.slug %}">Xem chi ti·∫øt s·∫£n ph·∫©m</a></strong>
            </p>
          </div>
          <button 
                class="product-button add-to-cart-quick" 
                data-product-id="{{ product.id }}" 
                data-variant-id="{{ variant.id }}"
            >
                Th√™m v√†o gi·ªè
            </button>
        </div>
            {% endif %}
          {% endwith %}
        {% empty %}
            <div class="no-results-container" style="grid-column: 1 / -1; padding: 50px 20px; text-align: center;">
              <div class="no-results-icon" style="font-size: 4rem; color: #d2d2d7; margin-bottom: 20px;">
                <i class="fas fa-search-minus"></i>
              </div>
              
              {% if search_query %}
                <h2 style="font-size: 24px; color: #1d1d1f; margin-bottom: 10px;">
                  Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "{{ search_query }}"
                </h2>
                <p style="color: #86868b; margin-bottom: 20px;">
                  H√£y th·ª≠ ki·ªÉm tra l·∫°i ch√≠nh t·∫£ ho·∫∑c s·ª≠ d·ª•ng c√°c t·ª´ kh√≥a kh√°c.
                </p>
              {% else %}
                <h2 style="font-size: 24px; color: #1d1d1f; margin-bottom: 10px;">
                  Hi·ªán ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
                </h2>
                <p style="color: #86868b;">
                  Vui l√≤ng quay l·∫°i sau.
                </p>
              {% endif %}
            </div>
          {% endfor %}
      </div>
    </main>

    {% include 'footer.html' %}

    <!-- Chatbox AI-->
    {% include 'chatbox.html' %}

    <script>
      const searchInput = document.getElementById("searchInput");
      const productGrid = document.getElementById("productGrid");
      const products = Array.from(productGrid.children);

      searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();

        // T√°ch s·∫£n ph·∫©m kh·ªõp v√† kh√¥ng kh·ªõp
        const matched = [];
        const unmatched = [];

        products.forEach((card) => {
          const name = card
            .querySelector(".product-detail h4")
            .innerText.toLowerCase();

          if (name.includes(query)) {
            matched.push(card);
          } else {
            unmatched.push(card);
          }
        });

        // X√≥a to√†n b·ªô grid v√† s·∫Øp l·∫°i th·ª© t·ª±
        productGrid.innerHTML = "";

        // Hi·ªán s·∫£n ph·∫©m kh·ªõp, ·∫©n s·∫£n ph·∫©m kh√¥ng kh·ªõp
        matched.forEach((card) => {
          card.style.display = "block";
          productGrid.appendChild(card);
        });
        unmatched.forEach((card) => {
          card.style.display = "none";
          productGrid.appendChild(card);
        });
      });
    </script>

    <script>
      // Isotope Filter Script
      var iso = new Isotope("#productGrid", {
        itemSelector: ".product-card",
        layoutMode: "fitRows",
        transitionDuration: 0,
      });

      function applyFilter() {
        let series = document.getElementById("filterSeries").value;
        let status = document.getElementById("filterStatus").value;
        let storage = document.getElementById("filterStorage").value;
        let price = document.getElementById("filterPrice").value;

        iso.arrange({
          filter: function (item) {
            let pSeries = item.getAttribute("data-series");
            let pStatus = item.getAttribute("data-status");
            let pStorage = item.getAttribute("data-storage");
            let pPrice = parseInt(item.getAttribute("data-price"));

            // Filter theo series
            if (series !== "*" && pSeries !== series) return false;

            // Filter theo tr·∫°ng th√°i (new, bestseller, promo)
            if (status !== "*" && pStatus !== status) return false;

            // Filter storage
            if (storage !== "*" && pStorage !== storage) return false;

            // Filter gi√°:
            if (price === "1" && pPrice > 10000000) return false;
            if (price === "2" && (pPrice < 10000000 || pPrice > 20000000))
              return false;
            if (price === "3" && pPrice < 20000000) return false;

            return true;
          },
        });
      }

      // G·ªçi l·∫°i filter khi thay ƒë·ªïi
      document.querySelectorAll(".filter-bar select").forEach((sel) => {
        sel.addEventListener("change", applyFilter);
      });
    </script>

    <script>
      $(document).ready(function() {
          // S·ª≠ d·ª•ng ·ªßy quy·ªÅn s·ª± ki·ªán ƒë·ªÉ Isotope kh√¥ng l√†m h·ªèng n√∫t b·∫•m
          $('#productGrid').on('click', '.add-to-cart-quick', function(e) {
              e.preventDefault();
              
              let button = $(this);
              let productId = button.data('product-id');
              let variantId = button.data('variant-id');
              
              button.prop('disabled', true).text('...');

              $.ajax({
                  url: "{% url 'add_to_cart' %}", // D√πng tag url c·ªßa Django cho ch·∫Øc ch·∫Øn
                  method: "POST",
                  data: {
                      'product_id': productId,
                      'variant_id': variantId,
                      'quantity': 1,
                      'csrfmiddlewaretoken': '{{ csrf_token }}'
                  },
                  success: function(response) {
                      if (response.status === 'success') {
                          alert("ƒê√£ th√™m iPad v√†o gi·ªè h√†ng!");
                          // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tr√™n Navbar
                          $('.cart-count').text(response.total_items);
                      }
                      button.prop('disabled', false).text('Th√™m v√†o gi·ªè');
                  },
                  error: function(xhr) {
                      if (xhr.status === 403) {
                          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p.");
                      } else {
                          alert("L·ªói k·∫øt n·ªëi server.");
                      }
                      button.prop('disabled', false).text('Th√™m v√†o gi·ªè');
                  }
              });
          });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>
    <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.js"></script>
    <script src="{% static 'js/app.js' %}"></script>
  </body>
</html>
